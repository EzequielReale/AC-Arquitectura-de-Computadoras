N_CLK EQU 10
N_F10 EQU 20
TIMER EQU 10H
CONT  EQU 10H
COMP  EQU 11H
PIC   EQU 20H
EOI   EQU 20H
IMR   EQU 21H
INT0  EQU 24H
INT1  EQU 25H
INT2  EQU 26H
INT3  EQU 27H
PIO   EQU 30H
PA    EQU 30H
PB    EQU 31H
CA    EQU 32H
CB    EQU 33H
HAND_DATO EQU 40H
HAND_ESTADO EQU 41H

ORG 20
ID_HAND DW IMPRIMIR; LA DIRECCION DE LA ID DE LA SUBRUTINA. 5*4=20

ORG 3000H
IMPRIMIR: PUSH AX; SALVO AX POR LAS DUDAS
MOV AL, [BX]; PONGO LA LETRA A IMPRIMIR EN AL
OUT HAND_DATO, AL; LA MANDO AL HANDSHAKE
INC BX; PASO AL SIGUIENTE CARÁCTER
DEC CL; DECREMENTO EL CONTADOR
JNZ FINAL ;SI NO LLEGA A 0 PERMITO QUE ME SIGA INTERRUMPIENDO

MOV AL, 0FFH; 11111111B
OUT IMR,AL; SI LLEGÓ A 0 FRENO LAS INTERRUPCIONES

FINAL: MOV AL, 20H
OUT EOI, AL; LE AVISO AL PIC QUE TERMINÉ

POP AX; RECUPERO AX
IRET


ORG 1000H
MENSAJE DB "SARANGANDUNGA MEREQUETENGUE"
FIN DB ?

ORG 2000H
MOV CL, OFFSET FIN-OFFSET MENSAJE; PONGO LA CANTIDAD DE CARÁCTERES EN CL
CLI; CONFIGURO EL PIC
MOV AL, 11111011B
OUT IMR, AL; HABILITO EN EL IMR SOLO LA INT2

MOV AL, 5; LA ID DE MI SUBRUTINA, EN ESTE CASO 5
OUT INT2, AL
STI; HABILITO DE NUEVO LAS INTERRUPCIONES

MOV BX, OFFSET MENSAJE; LE PASO A BX LA DIRECCIÓN DEL MENSAJE

; CONFIGURO EL HANDSHAKE PARA QUE FUNCIONE POR INTERRUPCIÓN FORZANDO UN 1 EN EL BIT MÁS SIGNIFICATIVO
IN AL, HAND_ESTADO
OR AL, 10000000B
OUT HAND_ESTADO, AL

; HASTA QUE NO LLEGUE AL ÚLTIMO CARÁCTER JMP
POLL:CMP CL, 0
JNZ POLL

; DESACTIVO EL ESTADO DE INTERRUPCIÓN DEL HANDSHAKE
IN AL, HAND_ESTADO
AND AL, 011111111B
OUT HAND_ESTADO, AL

INT 0
END